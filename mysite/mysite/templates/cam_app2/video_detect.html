{% extends "base.html" %}
{% load wagtailcore_tags %}
{% block extra_css %}

  <head>
    <title>Video Detection</title>
  </head>
  <!-- Poppins font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: #f2f5f8;
      padding-top: 80px;
    }
    .card-container {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.05);
      padding: 2rem;
      margin-bottom: 4rem;
    }
    h1.display-4 {
      color: #1f2a44;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }
    .subtitle {
      color: #555;
      margin-bottom: 2rem;
    }
    .file-drop-area {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 30px;
      border: 2px dashed #c1cbd8;
      border-radius: 8px;
      background: #fafbfc;
      transition: border-color .3s, background .3s;
    }
    .file-drop-area:hover {
      border-color: #1f2a44;
      background: #f0f3f7;
    }
    .choose-file-button {
      background: #ff7f50;
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: background .3s;
    }
    .choose-file-button:hover {
      background: #e76f3d;
    }
    .file-message {
      margin-left: 1rem;
      color: #777;
      font-size: 0.95rem;
    }
    .btn-primary {
      background: #1f2a44;
      border-color: #1f2a44;
      border-radius: 6px;
      font-weight: 600;
      padding: 10px 24px;
      transition: background .3s;
    }
    .btn-primary:hover {
      background: #151d2e;
    }
    .tabs {
      margin-top: 2rem;
    }
    .tabs button {
      background: none;
      border: none;
      padding: 8px 16px;
      font-weight: 600;
      color: #555;
      cursor: pointer;
      position: relative;
      margin-right: 8px;
    }
    .tabs button.active {
      color: #1f2a44;
    }
    .tabs button.active::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0; right: 0;
      height: 3px;
      background: #ff7f50;
      border-radius: 2px;
    }
    .tab-content {
      display: none;
      margin-top: 1rem;
    }
    .tab-content.active {
      display: block;
    }
    ul.file-list, ul.result-list {
      list-style: none;
      padding-left: 0;
      margin-top: 1rem;
    }
    ul.file-list li a, ul.result-list li a {
      color: #1f2a44;
      text-decoration: none;
    }
    ul.file-list li, ul.result-list li {
      padding: 6px 0;
      border-bottom: 1px solid #eee;
    }

    /* Lightbox styling */
    .lightbox {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center;
      z-index: 2000;
    }
    .lightbox-close {
      position: absolute; top: 20px; right: 30px; font-size: 3rem; color: #fff; cursor: pointer;
    }
    .lightbox-video {
      max-width: 90%; max-height: 90%; border-radius: 8px;
    }

    /* Summary panel */
    .summary-panel {
      margin-top: 2rem;
      padding: 1.5rem;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.05);
    }
    .summary-panel h3 {
      margin-bottom: 1rem;
      color: #1f2a44;
      font-weight: 600;
    }
    .summary-card {
      border: 1px solid #e4e9f0;
      border-radius: 6px;
      padding: 1rem;
      margin-bottom: 1rem;
    }
    .summary-card h5 {
      margin: 0 0 0.5rem;
      font-size: 1rem;
      font-weight: 600;
      color: #333;
    }
    .summary-card ul {
      list-style: none;
      padding-left: 0;
      margin: 0;
    }
    .summary-card ul li {
      font-size: 0.9rem;
      padding: 4px 0;
      border-bottom: 1px dotted #ddd;
    }
    .summary-card ul li:last-child {
      border-bottom: none;
    }

    .thumb-row {
      display: flex;
      gap: 8px;
      margin-top: 0.75rem;
    }
    .thumb-row img {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 4px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.1);
      cursor: pointer;
    }

    #loadingOverlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255,255,255,0.7);
      z-index: 3000;
      justify-content: center;
      align-items: center;
    }

    #loadingOverlay.active {
      display: flex;
    }

    .spinner {
      border: 8px solid #f3f3f3;
      border-top: 8px solid #1f2a44;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
{% endblock %}

{% block content %}
<div class="container card-container">

  <center>
    <h1 class="display-4">{{ page.name_title }}</h1>
    <p class="subtitle">{{ page.name_subtitle|richtext }}</p>
  </center>

  <!-- File Upload Form -->
  <form method="POST" enctype="multipart/form-data" id="form1">
    {% csrf_token %}
    <div class="file-drop-area">
      <button type="button" class="choose-file-button">Choose Videos</button>
      <span class="file-message">or drag & drop your videos here</span>
      <!-- hidden native input -->
      <input 
        type="file" 
        name="file_data" 
        class="file-input" 
        accept="video/*" 
        multiple 
        style="display:none;"
      >
    </div>
    <div class="text-center" style="margin-top:1rem;">
      <button class="btn btn-primary" type="submit">Upload</button>
    </div>
  </form>

  <!-- Uploaded Files List -->
  <ul class="file-list">
    {% for f in my_uploaded_file_names %}
      <li><a href="{{ f }}" target="_blank">{{ f|slice:'-30:' }}</a></li>
    {% empty %}
      <li class="text-muted">No videos selected.</li>
    {% endfor %}
  </ul>

  <!-- Start Detection -->
  <div class="text-center" style="margin-top:2rem;">
    <form method="POST" action=".">
      {% csrf_token %}
      <button class="btn btn-primary" type="submit" name="start">Start Detection</button>
    </form>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="active" data-tab="raw">Raw Video</button>
    <button data-tab="result">Result Video</button>
  </div>

  <!-- Tab Contents -->
  <div id="raw" class="tab-content active">
    <div class="grid-gallery">
      {% for vid in my_uploaded_file_names %}
        <video src="{{ vid }}" controls style="width:100%; border-radius:6px; box-shadow:0 2px 12px rgba(0,0,0,0.04);"></video>
      {% endfor %}
    </div>
  </div>
  
  <div id="result" class="tab-content">
    <div class="grid-gallery">
      {% for vid in my_result_file_names %}
        <video src="{{ vid }}" controls style="width:100%; border-radius:6px; box-shadow:0 2px 12px rgba(0,0,0,0.04);"></video>
      {% endfor %}
    </div>
    {% if detection_summary %}

    <!-- Damage Summary -->
    <div class="summary-panel">
      <h3>Detection Summary</h3>
      <p>Within this video, the following counts of damages were detected:</p>
      <ul>
          <li>Potholes: {{ damage_counts.D40 }}</li>
          <li>Alligator Cracks: {{ damage_counts.D20 }}</li>
          <li>Longitudinal Cracks: {{ damage_counts.D00 }}</li>
          <li>Traversal Cracks: {{ damage_counts.D10 }}</li>
      </ul>
  </div>

    <div class="summary-panel">
      {% for vid_key, dets in detection_summary.items %}
        <div class="summary-card">
          <h5>{{ vid_key }}</h5>
          <table style="width: 100%; border-collapse: collapse;">
            <thead> 
              <tr>
                <th style="border-bottom: 1px solid #ddd; padding: 8px; text-align: left;">Detection Type</th>
                <th style="border-bottom: 1px solid #ddd; padding: 8px; text-align: left;">Confidence</th>
                <th style="border-bottom: 1px solid #ddd; padding: 8px; text-align: left;">Timestamp (mm:ss)</th>
                <th style="border-bottom: 1px solid #ddd; padding: 8px; text-align: left;">Thumbnail</th>
              </tr>
            </thead>
            <tbody>
              {% for d in dets %}
                <tr>
                  <td style="padding: 8px;">{{ d.label }}</td>
                  <td style="padding: 8px;">{{ d.confidence|floatformat:2 }}</td>
                  <td style="padding: 8px;">{{ d.timestamp }}</td>
                  <td style="padding: 8px;">
                    <img src="{{ d.thumb_url }}" alt="crop" style="width: 60px; height: 60px; object-fit: cover; border-radius: 4px; cursor: pointer;" class="thumb-trigger" />
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% endfor %}
    </div>    
    {% endif %}
  </div>

  <!-- Lightbox markup -->
  <div id="lightbox" class="lightbox" style="display:none;">
    <span class="lightbox-close">&times;</span>
    <img class="lightbox-img" src="" alt="Preview">
  </div>

  <!-- Loading Spinner -->
  <div id="loadingOverlay">
    <div class="spinner"></div>
  </div>


</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script>
  $('form[action="."]').on('submit', function(){
    $('#loadingOverlay').addClass('active');
  });

  $(document).ready(function(){
    $('.choose-file-button').off('click').on('click', function(e){
      e.preventDefault();
      document.querySelector('.file-input').click();
    });

    $('.file-input').off('change').on('change', function(){
      var n = this.files.length;
      $('.file-message').text(
        n === 1 ? this.files[0].name : n + ' files selected'
      );
    });

    $('.tabs button').on('click', function(){
      var tab = $(this).data('tab');
      $('.tabs button').removeClass('active');
      $(this).addClass('active');
      $('.tab-content').removeClass('active');
      $('#' + tab).addClass('active');
    });

    $('.thumb-trigger').off('click').on('click', function(){
      var src = $(this).attr('src');
      $('.lightbox-img').attr('src', src);
      $('#lightbox').fadeIn(200);
    });
    $('.lightbox-close, .lightbox').on('click', function(){
      $('#lightbox').fadeOut(200);
    });
    $('.lightbox-img').on('click', function(e){
      e.stopPropagation();
    });
  });
</script>
{% endblock %}
